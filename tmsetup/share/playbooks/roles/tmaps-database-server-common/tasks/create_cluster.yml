# TmSetup - Automated setup and deployment of TissueMAPS in the cloud.
# Copyright (C) 2016  Markus D. Herrmann, University of Zurich

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

- name: Stop PostgreSQL service
  become: yes
  service:
    name=postgresql
    state=stopped
  tags:
    - database

# Symlink /var/lib/postgresql -> /data/storage/postgresql/
- name: Create data directory (source for symlink)
  become: yes
  file:
    path={{ db_data_directory }}
    state=absent
  tags:
    - database

- name: Create data directory (target for symlink) on mounted filesystem
  become: yes
  file:
    path={{ volume_mountpoint }}/storage/postgresql/data
    state=directory
    owner=postgres
    group=postgres
  tags:
    - database

- name: Symlink data directory to mounted filesystem
  become: yes
  file:
    src={{ volume_mountpoint }}/storage/postgresql/data
    dest={{ db_data_directory }}
    state=link
    force=yes
    owner=postgres
    group=postgres
  tags:
    - database

- name: Create version-specific data subdirectory
  become: yes
  file:
    path={{ db_data_directory }}/{{postgresql_version}}/{{ db_node }}
    state=directory
    owner=postgres
    group=postgres
  tags:
    - database

- name: Create log directory (source for symlink)
  become: yes
  file:
    path={{ db_log_directory }}
    state=absent
  tags:
    - database

- name: Create log directory (target for symlink) on mounted filesystem
  become: yes
  file:
    path={{ volume_mountpoint }}/storage/postgresql/logs
    state=directory
    owner=postgres
    group=postgres
  tags:
    - database

- name: Symlink log directory to mounted filesystem
  become: yes
  file:
    src={{ volume_mountpoint }}/storage/postgresql/logs
    dest={{ db_log_directory }}
    state=link
    force=yes
    owner=postgres
    group=postgres
  tags:
    - database

- name: Install setfacl support
  become: yes
  apt:
    pkg=acl
    state=installed
  tags:
    - database

- name: Remove empty default database cluster
  become: yes
  command: pg_dropcluster {{ postgresql_version }} main --stop
  ignore_errors: yes
  tags:
    - database

- name: Initialize database cluster
  become: yes
  command: pg_createcluster {{ postgresql_version }} {{ db_node }} -p {{ db_port }} -d {{ db_data_directory }}/{{ postgresql_version }}/{{ db_node }} -l {{ db_log_directory }}/postgresql-{{ postgresql_version }}-{{ db_node }}.log
  args:
    creates: "{{ db_data_directory }}/{{ postgresql_version }}/{{ db_node }}/base"
  tags:
    - database
