TmSetup - Automated setup and deployment of TissueMAPS in the cloud.
Copyright (C) 2016  Markus D. Herrmann, University of Zurich

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
---
- name: Install apt packages required by TissueMAPS Python packages
  become: yes
  apt:
    name: "{{ item }}"
    state: installed
  with_items:
    # h5py:
    - libhdf5-dev
    - hdf5-tools
    # lxml:
    - libxml2-dev
    - libxslt1-dev
    # javabridge
    - openjdk-7-jdk
    # matplotlib:
    - pyqt4-dev-tools
    - libfreetype6-dev
    # shapely:
    - libgeos-dev
  tags:
    - tissuemaps

- name: Install numpy and cython Python packages
  become: yes
  command: /usr/local/bin/pip install cython --upgrade
  # Using the pip module doesn't work???
  # pip: name=cython
  tags:
    - tissuemaps

- name: Clone JtLibrary repository
  git:
    repo={{ tm_github_url }}/jtlibrary
    dest={{ ansible_env.HOME }}/jtlibrary
    version={{ jtlibrary_branch }}
    force=yes
  tags:
    - tissuemaps

- name: Install jtlibrary package
  shell: pip install -e {{ ansible_env.HOME }}/jtlibrary --user
  args:
    chdir={{ ansible_env.HOME }}/jtlibrary/
    executable=/bin/bash
  tags:
    - tissuemaps

# - name: Install jtlibrary package
#   pip:
#     name: "git+{{ tm_github_url }}/jtlibrary@{{ jtlibrary_branch }}#egg=jtlibrary"
#     extra_args: "--user --process-dependency-links"
#   tags:
#     - tissuemaps

- name: Clone JtModules repository
  git:
    repo={{ tm_github_url }}/jtmodules
    dest={{ ansible_env.HOME }}/jtmodules
    version={{ jtmodules_branch }}
    force=yes
  tags:
    - tissuemaps

- name: Install jtmodules package
  shell: pip install -e {{ ansible_env.HOME }}/jtmodules --user
  args:
    chdir={{ ansible_env.HOME }}/jtmodules/
    executable=/bin/bash
  tags:
    - tissuemaps

# - name: Install jtmodules package
#   pip:
#     name: "git+{{ tm_github_url }}/jtmodules@{{ jtmodules_branch }}#egg=jtmodules"
#     extra_args: "--user --process-dependency-links"
#   tags:
#     - tissuemaps

# NOTE: When including the GC3Pie dependency via --process-dependency-links
# upon installation of tmlibrary, I get HTTP erros when installing on multiple
# hosts simulatneously???
- name: Install GC3Pie
  pip:
    name=git+{{ tm_github_url }}/gc3pie@master#egg=gc3pie
    extra_args="--user"
  tags:
    - tissuemaps

- name: Clone TmLibrary repository
  git:
    repo={{ tm_github_url }}/tmlibrary
    dest={{ ansible_env.HOME }}/tmlibrary
    version={{ tmlibrary_branch }}
    force=yes
  tags:
    - tissuemaps

- name: Install tmlibrary package
  shell: pip install -e {{ ansible_env.HOME }}/tmlibrary --user
  args:
    chdir={{ ansible_env.HOME }}/tmlibrary/
    executable=/bin/bash
  tags:
    - tissuemaps

# - name: Install tmlibrary package
#   pip:
#     name: "git+{{ tm_github_url }}/tmlibrary@{{ tmlibrary_branch }}#egg=tmlibrary"
#     extra_args: "--user --process-dependency-links"
#   tags:
#     - tissuemaps

- name: Clone TmToolbox repository
  git:
    repo={{ tm_github_url }}/tmtoolbox
    dest={{ ansible_env.HOME }}/tmtoolbox
    version={{ tmtoolbox_branch }}
  tags:
    - tissuemaps

- name: Install tmtoolbox package
  shell: pip install -e {{ ansible_env.HOME }}/tmtoolbox --user --process-dependency-links
  args:
    chdir={{ ansible_env.HOME }}/tmtoolbox/
    executable=/bin/bash
  tags:
    - tissuemaps

# - name: Install tmtoolbox package
#   pip:
#     name: "git+{{ tm_github_url }}/tmtoolbox@{{ tmtoolbox_branch }}#egg=tmtoolbox"
#     extra_args: "--user --process-dependency-links"
#   tags:
#     - tissuemaps

- name: Create directory for TissueMAPS related files
  file: path={{ ansible_env.HOME }}/.tmaps state=directory
  tags:
    - tissuemaps
    - config

- name: Create TissuMAPS library part of the configuration
  shell: "{{ tmaps_install_location }}/tm_create_config"
  tags:
    - tissuemaps
    - config

