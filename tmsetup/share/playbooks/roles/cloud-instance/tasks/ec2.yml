# TmSetup - Automated setup and deployment of TissueMAPS in the cloud.
# Copyright (C) 2016  Markus D. Herrmann, University of Zurich

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

---
# Playbook for creating a virtual machine instance on Elastic Compute Cloud 2 (EC2).
#
# Requires the following environment variables:
#  - AWS_ACCESS_KEY_ID
#  - AWS_SECRET_ACCESS_KEY
- name: Define boot disk
  set_facts:
    instance_disks:
      # TODO: SSD device for root file system?
      - device_name: /dev/sda1
        volume_size: "{{ disk_size }}"
        volume_type: gp2
        delete_on_termination: yes
  when: disk_size is defined

- name: Use default boot disk
  set_facts:
    intsance_disks: []
  when: disk_size is not defined

- name: "{{ (instance_state == 'present') | ternary('Create','Remove') }} instance"
  local_action: ec2
  args:
    state: "{{ instance_state }}"
    key_name: "{{ key_name }}"
    image: "{{ image }}"
    instance_type: "{{ flavor }}"
    count: 1
    instance_tags:
       Name: "{{ item }}"
    groups: "{{ security_groups }}"
    wait: true
    wait_timeout: 300
    volumes: "{{ instance_disks }}"
    # ebs_optimized: no
    # assign_public_ip: yes
    # vpc_subnet_id: "{{ network }}"
    network: "{{ network }}"
    region: "{{ region }}"
  register: instance

- name: Register IP address of created instance
  set_fact:
    instance_public_ip: "{{ instance.instances[0].public_ip }}"
  when: instance_state == 'present'

- name: "{{ (instance_state == 'present') | ternary('Create','Remove') }} storage volume and attach it to instance"
  local_action: ec2_vol
  args:
    state: "{{ instance_state }}"
    device_name: "{{ volume_device[provider] }}"
    instance: "{{ instance.instances[0].id }}"  # TODO: Does this work upon termination?
    delete_on_termination: yes
    name: "{{ volume_name }}"
    region: "{{ region }}"
    volume_type: standard
    volume_size: "{{ volume_size }}"
  when: volume_size is defined
