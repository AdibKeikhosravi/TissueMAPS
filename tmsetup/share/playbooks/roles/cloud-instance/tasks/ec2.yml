---
# Playbook for creating a virtual machine instance on Elastic Compute Cloud 2 (EC2).
#
# Requires the following environment variables:
#  - AWS_ACCESS_KEY_ID
#  - AWS_SECRET_ACCESS_KEY
- name: "{{ (instance_state == 'present') | ternary('Create','Remove') }} instance"
  ec2:
    state: "{{ instance_state }}"
    key_name: "{{ key_name }}"
    image: "{{ image }}"
    instance_type: "{{ flavor }}"
    count: 1
    instance_tags:
       Name: "{{ item }}"
    groups: "{{ security_groups }}"
    wait: true
    wait_timeout: 300
    volumes:
      # TODO: SSD device for root file system?
      - device_name: /dev/sda1
        volume_size: "{{ disk_size }}"
        volume_type: gp2
        delete_on_termination: yes
    # ebs_optimized: no
    # assign_public_ip: yes
    # vpc_subnet_id: "{{ network }}"
    network: "{{ network }}"
    region: "{{ region }}"
  register: instance

- name: Register IP address of created instance
  set_fact:
    instance_public_ip: "{{ instance.instances[0].public_ip }}"
  when: instance_state == 'present'

- name: "{{ (instance_state == 'present') | ternary('Create','Remove') }} storage volume and attach it to instance"
  ec2_vol:
    state: "{{ instance_state }}"
    device_name: "{{ volume_device[provider] }}"
    instance: "{{ instance.instances[0].id }}"  # TODO: Does this work upon termination?
    delete_on_termination: yes
    name: "{{ volume_name }}"
    region: "{{ region }}"
    volume_type: standard
    volume_size: "{{ volume_size }}"
  when: volume_size is defined
