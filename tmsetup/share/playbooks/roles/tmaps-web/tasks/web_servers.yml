TmSetup - Automated setup and deployment of TissueMAPS in the cloud.
Copyright (C) 2016  Markus D. Herrmann, University of Zurich

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
---
- name: Update all packages to the latest version
  become: yes
  apt: upgrade=safe update_cache=yes cache_valid_time=3600
  tags:
    - nginx
    - web

- name: Install NGINX
  become: yes
  apt: name=nginx state=installed
  tags:
    - web
    - nginx

# - name: Install uWSGI
#   become: yes
#   apt:
#     name: "{{ item }}"
#     state: installed
#   with_items:
#     - uwsgi
#     - uwsgi-plugin-python
#   tags:
#     - web
#     - uwsgi

- name: Install latest uWSGI packages
  become: yes
  pip: name=uwsgi editable=false
  tags:
    - uwsgi
    - web

- name: Place uwsgi.ini
  template: src=uwsgi.ini.j2 dest="{{ ansible_env.HOME }}/.tmaps/uwsgi.ini"
  tags:
    - web
    - uwsgi

- name: Place flask uwsgi wrapper
  template: src=uwsgi.sh.j2 dest="{{ ansible_env.HOME }}/.tmaps/uwsgi.sh"
  tags:
    - web
    - uwsgi

- name: Create an upstart scripts
  become: yes
  template: src=uwsgi.conf.j2 dest="/etc/init/uwsgi.conf"
  notify:
    - restart uwsgi
  tags:
    - web
    - uwsgi

- name: Create nginx site
  become: yes
  template: src=nginx_site.j2 dest="/etc/nginx/sites-available/tissuemaps"
  notify:
    - restart nginx
  tags:
    - nginx
    - web

- name: Put nginx conf.d
  become: yes
  template: src=nginx_conf.j2 dest="/etc/nginx/conf.d/tmaps.conf"
  notify:
    - restart nginx
  tags:
    - nginx
    - web

# Check syntax of the nginx file:
# $ become nginx -t

- name: Enable nginx site
  become: yes
  shell: |
    if [ ! -s /etc/nginx/sites-enabled/tissuemaps ]; then
      ln -s /etc/nginx/sites-available/tissuemaps /etc/nginx/sites-enabled/tissuemaps
    fi
    if [ -s /etc/nginx/sites-enabled/default ]; then
      rm /etc/nginx/sites-enabled/default
    fi
  notify:
    - restart nginx
    - restart uwsgi
  tags:
    - nginx
    - web

- name: Add redis repo
  become: yes
  apt_repository: repo='ppa:chris-lea/redis-server' validate_certs=no
  tags:
    - redis
    - web

- name: Update all packages to the latest version
  become: yes
  apt: upgrade=safe update_cache=yes cache_valid_time=3600
  tags:
    - redis
    - web

- name: Install redis server
  become: true
  apt: name=redis-server state=installed
  tags:
    - redis
    - web
