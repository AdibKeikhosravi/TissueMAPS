# TmSetup - Automated setup and deployment of TissueMAPS in the cloud.
# Copyright (C) 2016  Markus D. Herrmann, University of Zurich

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

---
- name: Perform post-configuration
  hosts: tissuemaps_web
  vars:
    tmaps_install_location: "{{ ansible_env.HOME }}/.local/bin"
  tasks:
    - name: Create database tables
      command: "{{ tmaps_install_location }}/tm_create_tables"
      tags:
        - web
        - database
        - tissuemaps

    - name: Create default user
      command: "{{ tmaps_install_location }}/tm_add user --name testuser --password {{ tm_testuser_password }} --email testuser@tissuemaps.org"
      tags:
        - web
        - database
        - tissuemaps
      when: tm_testuser_password is defined

    - name: Place convenience scripts
      template:
        src={{ playbook_dir }}/templates//{{ item }}.j2
        dest={{ ansible_env.HOME }}/{{ item }}
        mode="u+x"
      with_items:
        - create_slurm_account.sh
        - start_server.sh
        - stop_server.sh

