#!/usr/bin/env python
import os
import sys
import argparse
import sqlalchemy.orm.exc

import tmlib.models as tm

# Don't trash the user with long tracebacks
sys.tracebacklimit = 0


def valid_dir(path):
    if not os.path.exists(path):
        raise OSError('Provided path does not exist: %s' % path)
    return path


def add_experiment(experiment_name, user_name, microscope_type, plate_format,
                   plate_acquisition_mode):
    with tm.utils.MainSession() as session:
        try:
            user = session.query(tm.User).\
                filter_by(name=user_name).\
                one()
        except sqlalchemy.orm.exc.NoResultFound:
            raise ValueError('Unknown user "%s"!' % user_name)
        except:
            raise
        experiment = session.get_or_create(
            tm.Experiment,
            name=experiment_name, user_id=user.id,
            root_directory=os.environ['TMAPS_STORAGE_HOME'],
            microscope_type=microscope_type,
            plate_format=plate_format,
            plate_acquisition_mode=plate_acquisition_mode
        )
        return experiment.id


if __name__ == '__main__':

    parser = argparse.ArgumentParser(
        description='Add a new experiment to the TissueMAPS database.'
    )
    parser.add_argument(
        '-e', '--experiment_name', required=True, type=str,
        help='name of the experiment'
    )
    parser.add_argument(
        '-u', '--user_name', required=True, type=str,
        help='user name'
    )
    parser.add_argument(
        '--plate_format', type=int, default=384,
        choices={1, 96, 384},
        help='well plate format (default: 384)'
    )
    parser.add_argument(
        '--microscope_type', type=str, default='cellvoyager',
        choices={'cellvoyager', 'visiview', 'axio'},
        help='microscope type (default: cellvoyager)'
    )
    parser.add_argument(
        '--plate_acquisition_mode', type=str, default='basic',
        choices={'basic', 'multiplexing'},
        help='''
            whether multiple acquisitions of the same plate are interpreted 
            as time points or multiplexing iterations (default: basic)
        '''
    )

    args = parser.parse_args()

    experiment_id = add_experiment(
        args.experiment_name, args.user_name, args.microscope_type,
        args.plate_format, args.plate_acquisition_mode
    )

    print(
        'EXPERIMENT ID: {id}\nYou will need the ID to process the '
        'experiment via the command line!'.format(id=experiment_id)
    )
