#!/usr/bin/env python
import os
import re
import shutil
import argparse
import paramiko
import sqlalchemy.orm.exc

import tmlib.models as tm
from tm.status import FileUploadStatus
from tmlib.workflow.metaconfig import import_microscope_type_module


class RemoteFileCopy(object):

    def __enter__(self):
        # TODO
        hostname = ''
        username = ''
        key_name = ''
        self.ssh = paramiko.SSHClient()
        key = paramiko.RSAKey.from_private_key_file(
            os.path.expanduser(os.path.join('~', '.ssh', key_name))
        )
        self.ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        self.connect(hostname=hostname, username=username, pkey=key)
        self.sftp = self.ssh.open_sftp()
        return self

    def __exit__(self, except_type, except_value, except_trace):
        self.sftp.close()
        self.ssh.close()

    def copy(self, src, dst):
        self.sftp.put(src, dst)


class LocalFileCopy(object):

    def __enter__(self):
        return self

    def __exit__(self, except_type, except_value, except_trace):
        pass  # ???

    def copy(self, src, dst):
        shutil.copyfile(src, dst)


if __name__ == '__main__':

    parser = argparse.ArgumentParser(
        description='''
            Add microscope files to an existing acquisition
            in the TissueMAPS database.
        '''
    )
    parser.add_argument(
        '-e', '--experiment_name', required=True,
        help='name of the parent experiment'
    )
    parser.add_argument(
        '-p', '--plate_name', required=True,
        help='name of the parent plate'
    )
    parser.add_argument(
        '-a', '--acquisition_name', required=True,
        help='name of the new acquisition'
    )
    parser.add_argument(
        '-s', '--source_directory', required=True,
        help='path to directory that contains the microscope files'
    )

    args = parser.parse_args()

    with tm.utils.Session() as session:

        try:
            acquisition = session.query(tm.Acquisition).\
                join(tm.Plate).\
                join(tm.Experiment).\
                filter(tm.Experiment.name == args.experiment_name).\
                filter(tm.Plate.name == args.plate_name).\
                filter(tm.Acquisition.name == args.acquisition_name).\
                one()
        except sqlalchemy.orm.exc.NoResultFound:
            raise ValueError(
                'Acquisition "%s" does not exist for plate "%s" and '
                'experiment "%s"!'
                % (args.acquisition_name, args.plate_name, args.experiment_name)
            )
        except:
            raise

        # Register all files in the database.
        # This will automatically set upload_status to "WAITING".
        if not os.path.exists(args.source_directory):
            raise OSError(
                'Source directory does not exist: %s' % args.source_directory
            )
        microscope_type = acquisition.plate.experiment.microscope_type
        r_image, r_metadata= get_microscope_type_regex(microscope_type)
        image_file_names = [
            f.name for f in acquisition.microscope_image_files
        ]
        metdata_file_names = [
            f.name for f in acquisition.microscope_metadata_files
        ]
        for f in os.listdir(args.source_directory):
            if r_image.search(f):
                name = os.path.basename(f)
                # Skip already inserted files.
                if name not in image_file_names:
                    print 'register image file "%s"' % name
                    file = session.get_or_create(
                        tm.MicroscopeImageFile,
                        name=name, acquisition_id=acquisition.id
                    )
            elif r_metadata.search(f):
                name = os.path.basename(f)
                if name not in metdata_file_names:
                    print 'register metadata file "%s"' % name
                    file = tm.MicroscopeMetadataFile(
                        name=name, acquisition_id=acquisition.id
                    )
                    session.add(file)
                    session.flush()

        session.commit()

        # with LocalFileCopy() as c:

        #     # Copy ("upload") the files and update their upload_status.
        #     for f in acquisition.microscope_image_files:
        #         if f.upload_status != FileUploadStatus.COMPLETE:
        #             print 'copy image file "%s"' % f.name
        #             src = os.path.join(args.source_directory, f.name)
        #             dst = f.location
        #             f.upload_status = FileUploadStatus.UPLOADING
        #             session.add(f)
        #             session.commit()
        #             c.copy(src, dst)
        #             f.upload_status = FileUploadStatus.COMPLETE
        #             session.add(f)
        #             session.commit()

        #     for f in acquisition.microscope_metadata_files:
        #         if f.upload_status != FileUploadStatus.COMPLETE:
        #             print 'copy metadata file "%s"' % f.name
        #             src = os.path.join(args.source_directory, f.name)
        #             dst = f.location
        #             f.upload_status = FileUploadStatus.UPLOADING
        #             session.add(f)
        #             session.commit()
        #             c.copy(src, dst)
        #             f.upload_status = FileUploadStatus.COMPLETE
        #             session.add(f)
        #             session.commit()
