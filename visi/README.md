# visi #

[Visi](visi) is a command line tool for converting **.stk** files from Visitron microscopes into **.png** images with optional file renaming.

For help, do
```{bash}
visi -h
```

Required (positional) arguments: 	
* `files`: a list .stk files thats should be processed generated by wildcards (globbing pattern, e.g. ./STK/*) 	 	

```{bash}
visi [files]
```

By default, the output directory will be the parent directory of the input folder. In the output directory a subdirectory called "TIFF" will be created (i.e. `../TIFF`), where the *.png* images will be stored.

You can change the default output directory (i.e. the parent directory of the final image folder) using the `-o` or `--output_dir` command:

```{bash} 
visi [files] -o [output_dir]
```

You can also change the name of the folder where the input files are stored using the `--output_dir_name` command:

```{bash} 
visi [files] --output_dir_name [output_dir_name]
```

## Renaming ##

The names of the .stk files may not encode sufficient information. To this end, files can be renamed during conversion and additional information can be included in the filename for more convenient processing later on.

If you want to rename files, use the `-r` or `--rename` argument:
```{bash}
visi [files] -r
```

By default, images are renamed according a standard configuration (see [visi.config](visi.config)). 

```{yaml}
nomenclature_string: '{project}_{well}_s{site}_r{row}_c{column}_z{zstack}_t{time}_{filter}_C{channel}.png'

nomenclature_format: 
    project: '%s'
    well: '%s'
    site: '%.4d'
    row: '%.2d'
    column: '%.2d'
    zstack: '%.2d'
    time: '%.4d'
    filter: '%s'
    channel: '%.2d'

acquisition_mode: 'ZigZagHorizontal'

acquisition_layout: 'columns'
```

The default nomenclature is simply a suggestion and should be subject to further discussion. If you want to rename files differently, you can use a custom *YAML* configuration file.
To this end, simply create a copy of the `visi.config` file and place it in your project folder.

To use a custom configuration file, use the `-c` or `--config` argument:
```{bash}
visi [files] -r -c [config_filename]
```

## Unpacking ##

If you have several *.nd* files in your input folder, you might want to store the corresponding *.png* output files in separate folders. To this end, use the `-s` or `--split_output` command.

```{bash}
visi [files] -s
```

This will create separate folders in the output directory using the basename of each corresponding *.nd* file as folder name. Each of these folders will themselves contain a "TIFF" folder with the actual images (or with another name if you overwrite the default).

## Parallel processing ##

If you don't want to process all .stk files at once, you can specify which "jobs" should be processed.

This can be done by specifying individual jobs directly using the `-j` or `--jobs` argument

```{bash}
visi [files] -j 1 2 3
```

or by specifying a "batch", i.e. a range of jobs, using the `-b` or `--batch` argument

```{bash}
visi [files] -b 1-3
```

You also have the possibility to create a "joblist" in advance. A joblist is a file in *YAML* syntax that lists all jobs as key-value pairs, where the key specifies the job ID and the value the corresponding filename.

The content of a joblist file would look as follows:
```{yaml}
1: /absolute/path/to/image1.stk
2: /absolute/path/to/image2.stk
3: /absolute/path/to/image3.stk
...
```

Note that for convenience job IDs are one-based and will be translated to Python's zero-based indexing internally.

To create such joblist files, do:

```{bash}
visi [files] -o [output_dir] --joblist
```

In this case, the output directory is the location where the joblist files will be written.

With this functionality, you can conveniently loop over jobs in a cluster submission script to process files in parallel (see below).


### Installation ###

In order to be able to run this script on Brutus, you will first have to clone the *PelkmansLibrary* repository that contains this package:
```{bash}
git clone git@github.com:pelkmanslab/PelkmansLibrary.git ~/pelkmanslib
```

Then add the following lines to your .bash_profile file:
```{bash}
	export PATH=$PATH:$HOME/pelkmanslib/python/visi
	export PYTHONPATH=$PYTHONPATH:$HOME/pelkmanslib/python
```


### Use on Brutus ###

The repository contains the example submission script [bsub_visi.py](bsub_visi.py). You can adapt it locally to your needs. Please don't push your changes.

On Brutus you will need to load Python and install a couple of Python packages.

To load python, do:
```{bash}
module load python/2.7.2
```

You can also put the above line in your .bash_profile file to always load Python when you connect to Brutus.

To install packages do:
```{bash}
pip install [package_name] --user
```


TODO: setup.py file for installation of dependencies.

